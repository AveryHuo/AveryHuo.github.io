---
title: 内存管理
categories:
- Unity学习
tags: 
- Unity学习
---

## 物理内存

当指令不连贯时，将会产生大量的时间浪费，DOTS和ECS从这个方面优化了内存的访问性能。

![DOTS的目的](/img/1578646439353.png)

> 日志常见： OOM，显存大小无法分配过来的报错信息
![移动设备的区别](/img/1578646594733.png)

> 三级缓存：
> 台式：主流在8~16MB
> 移动端：高端如845，2M

## 虚拟内存


![虚拟内存](/img/1578646743161.png)
> 交换内存： 当操作系统内存不够时，尝试把不用的内存(deadmemory)交换到硬盘上，从而节省出更多物理内存。
> 为什么移动端没有内存交换：移动设备IO速度慢，存储器的可擦写次数较台式少。
> IOS提供了把不活跃的内存压缩起来放到一个特定空间。Virtual memory 很大。


## 内存寻址范围

可简单认为64位CPU寻址范围大。

## 安卓内存管理

![安卓内存](/img/1578647010062.png)

> Page: 一般4K一个Page
> 回收和分配以page为单位
> 用户态和内核态

> LMK, low memeory killer
> 分类：
> Native： adbd等，adb的守护线程
> System: 系统服务
> Persistent: 电话，信息，蓝牙等等
> Foreground: 应用
> Perceptible: 搜索等等
> Services： 服务，云服务等
> Home:主界面
> Previous: 之前上一个应用
> Cached:　后台

> 从低层开始往上杀。 Foreground其实就是闪退的表现。杀到System就重启了。
![优化级](/img/1578651845843.png)

## 安卓内存指标

![内存指标](/img/1578652129043.png)

> RSS: 当前APP所使用的所有内存
> PSS: 公共库分配出来的内存
> USS：只有自己使用的内存，一般在此处优化

> procrank 指令



## Unity内存管理

![Unity引擎](/img/1578652476304.png)

>Unity 内存按照分配方式分为：
> - Native Memory
>- Managed Memory
>- Editor & Runtime 是不同的
    - 不止是统计看到的内存大小不同，甚至是内存分配时机和方式也不同
    - Asset 在 Runtime 中如果不读取，是不会进内存的，但 Editor 打开就占内存。因为 Editor 不注重 Runtime 的表现，更注重编辑器中编辑时的流畅。
        - 但如果游戏庞大到几十个 G，如果第一次打开项目，会消耗很多时间，有的大的会几天，甚至到一周。